alias lp='ls -lrt -d -1 "$PWD"/{*,.*}'
HOMEDIR=/home/$HOSTNAME
cd $HOMEDIR
readarray -t applist < <(ls -l $HOMEDIR/| awk '/^d/ {print $NF}')

[[ -d /var/cw/systeam/.vim-backup ]] || mkdir /var/cw/systeam/.vim-backup > /dev/null 2>&1
cat <<- _EOF_ > /root/.vimrc
set pastetoggle=<F3>
nnoremap <F4> :set number!<CR>
syntax on
filetype on
set backup
set backupdir=/var/cw/systeam/.vim-backup
set writebackup
set backupcopy=yes
au BufWritePre * let &bex ='_at_' . strftime("%F-%H-%M")
set hlsearch
set tabstop=4
set softtabstop=4
set shiftwidth=4
set ignorecase
set smartcase
_EOF_

[[ -d /var/cw/systeam/.nano-backup ]] || mkdir /var/cw/systeam/.nano-backup > /dev/null 2>&1
cat <<- _EOF_ > /root/.nanorc
set linenumbers
set tabsize 4
_EOF_

nano() {
    for file in "$@"; do
        if [[ -f "$file" && ! "$file" =~ ^- ]]; then
            cp "$file" "/var/cw/systeam/.nano-backup/$(basename "$file")_$(date +%F-%H-%M-%S)"
        fi
    done
    /bin/nano "$@"
}


# pud - enhanced pushd wrapper that accepts:
# 1) directory path
# 2) +N (rotate stack forward N times)
# 3) -N (rotate stack backward N times)
pud() {
  if [ $# -ne 1 ]; then
    echo "Usage: pud <directory|+N|-N>"
    return 1
  fi

  arg="$1"

  # Match +N or -N
  if [[ "$arg" =~ ^\+([0-9]+)$ ]]; then
    n="${BASH_REMATCH[1]}"
    pushd "+${n}" >/dev/null
  elif [[ "$arg" =~ ^\-([0-9]+)$ ]]; then
    n="${BASH_REMATCH[1]}"
    pushd "-${n}" >/dev/null
  else
    # Otherwise treat as directory path or numeric index (or path)
    # pushd accepts numeric index without + or - for stack rotation in bash >=4.4
    pushd "$arg" >/dev/null
  fi
}


# dl - run dirs with selected flags, accepting letters v, c, l corresponding to -v, -c, -l
dl() {
  # Build flags string from letters
  flags=""
  for arg in "$@"; do
    case "$arg" in
      v) flags="$flags -v" ;;
      c) flags="$flags -c" ;;
      l) flags="$flags -l" ;;
      *) echo "Invalid option: $arg"
         return 1 ;;
    esac
  done

  # Run dirs with constructed flags
  dirs $flags
}

inc_worker() {
    # Set TasksMax to infinity
    systemctl set-property apache2.service TasksMax=infinity

    # Restart the Apache service
    /etc/init.d/apache2 restart

    # Optionally, print a message
    echo "TasksMax set to infinity and Apache service restarted."
}

worker_th() {
    systemctl show apache2.service -p TasksMax
}

imunify_status (){
    local var="$1"

    echo "Checking Global Black/Grey listing for IP: $var"
    imunify360-agent ip-list synced --by-ip "$var"

    echo "Checking Local Black/Grey listing for IP: $var"
    imunify360-agent ip-list local list --by-ip "$var"
}

imunify_white (){
      local var="$1"

    echo "Adding IP: $var to Local Whitelist with purpose 'white'."
    imunify360-agent ip-list local add --purpose white "$var"
}

imunify_black (){
      local var="$1"

    echo "Adding IP: $var to Local Blacklist with purpose 'black'."
    imunify360-agent ip-list local add --purpose drop "$var"
}


backup_zip() {

    if [ -z "$1" ]; then
        echo "Usage: backup_zip <filename> [-p]"
        return 1
    fi

    FILENAME="$1"
    FLAG="$2"

    curl -s https://raw.githubusercontent.com/salimalikhan22/Cloudways/refs/heads/master/scripts/backup.sh \
        | bash -s -- "$FILENAME" "$FLAG"

}


snr_file(){
      local target_text="$1"       # The text to find
    local replacement_text="$2"  # The text to replace with
    local file_name="$3"         # The name of the file to modify

    # Perform search and replace using sed
    echo "Replacing '$target_text' with '$replacement_text' in file: $file_name"
    sed -i "s|$target_text|$replacement_text|g" "$file_name"
}

snr_allfile(){
    local search_text="$1"       # The text to find
    local replace_text="$2"      # The text to replace with

    # Perform search and replace using find and sed
    echo "Replacing '$search_text' with '$replace_text' in all files under the current directory."
    find ./ -type f -exec sed -i -e "s|$search_text|$replace_text|g" {} \;
}

high_cpu(){
    # Change to the home directory
    cd ~ || { echo "Failed to change to home directory."; return 1; }

    # Download the script
    wget https://github.com/salimalikhan22/Cloudways/raw/refs/heads/master/scripts/apm.sh -O apm.sh

    # Check if wget was successful
    if [[ $? -ne 0 ]]; then
        echo "Failed to download the script."
        return 1
    fi

    # Execute the script
    bash apm.sh

    # Check if the script executed successfully
    if [[ $? -ne 0 ]]; then
        echo "The script encountered an error during execution."
        return 1
    fi

    # Remove the script
    rm apm.sh

    echo "Script executed and removed successfully."
}

restore() {
    # Set URL and temporary script path
    SCRIPT_URL="https://github.com/salimalikhan22/Cloudways/raw/refs/heads/master/scripts/restore.sh"
    TMP_SCRIPT="/tmp/restore.sh"

    echo "Downloading restore script to $TMP_SCRIPT..."

    # Download the restore script to /tmp
    wget -q "$SCRIPT_URL" -O "$TMP_SCRIPT"
    if [[ $? -ne 0 ]]; then
        echo "Failed to download the restore script."
        return 1
    fi

    # Make it executable
    chmod +x "$TMP_SCRIPT"

    echo "Executing restore script..."
    # Execute the script
    bash "$TMP_SCRIPT"
    if [[ $? -ne 0 ]]; then
        echo "The restore script encountered an error during execution."
        rm -f "$TMP_SCRIPT"
        return 1
    fi

    # Remove the script after execution
    rm -f "$TMP_SCRIPT"
    echo "Restore script executed and removed successfully."
}


######################################################################################################################


ipinfo () {
        /usr/bin/curl -s "https://ipinfo.io/$1\?token=0b4b40014973a0"
        }

magerun () {
  FILE="/usr/bin/n98-magerun2"
  if [[ -s $FILE ]]; then
      /usr/bin/n98-magerun2 "$@" --skip-root-check
  else
      echo "Program is not installed.. Installing now..."
      curl -sS -O https://files.magerun.net/n98-magerun2-latest.phar && chmod +x n98-magerun2-latest.phar
        if [[ $(echo $?) == '0' ]]; then
                mv n98-magerun2-latest.phar /usr/bin/n98-magerun2
                /usr/bin/n98-magerun2 "$@" --skip-root-check
        else
                echo "Automatic install failed. Please install manually."
        fi
  fi
  }


app () {
        grep -lr "$(echo -e "$1" | sed -e 's|^[^/]*//| |' -e 's|/.*$||')" $HOMEDIR/*/conf | \
        awk 'END{split($0,a,"/"); print a[4]}'
        }

wp () {
        sudo --user="$(stat -c '%U' .)" /usr/local/bin/wp "$@"
        }

host () {
        /usr/bin/host $(echo $1 | sed -e 's|^[^/]*//||' -e 's|/.*$||')
        }

master () {
        su $(grep master /etc/passwd | head -n 1 | cut -d ":" -f1)
        }

slowlog() {
        if [ $# -eq 0 ]; then
             echo -n $'\U274E '
             echo '[WARN] You did not provide any app.'
             echo "Available apps are: ${applist[*]}"
        else
            for args in "$@"
                do
                  cl_args=${args%/}
                  if app_exist "${applist[*]}" "$cl_args"; then
                    echo ""
                    echo -e "App: $cl_args"
                    gawk 'NR==1 {print substr($NF, 1, length($NF)-1)}' $HOMEDIR/$cl_args/conf/server.nginx
                    for PID in $(gawk '{print}' $HOMEDIR/$cl_args/logs/php-app.access.log | sort -nbrk 12,12 |  \
                    head| gawk '{print $11}')
                        do
                          gawk "/pid $PID/,/^$/" $HOMEDIR/$cl_args/logs/php-app.slow.log
                        done
                  else
                    echo ""
                    echo -n $'\U274E '
                    echo "There seems to be no app by the name, $cl_args.."
                    echo "Available apps are: ${applist[*]}"
                  fi
                done
        fi
        }


concurr () {
        watch -xtn 0.5 awk '$2 ~ /:0050|:01BB/ && $4 ~ /01/ {count +=1;} END {print "Concurrent Web Connections: ",count}' /proc/net/tcp
        }

app_exist () {
APPS=$1
VALUE=$2
echo $APPS| tr ' ' '\n' | grep -x -q -F "$VALUE"
}

list-restore () {

if [ $# -eq 0 ]; then
                for i in $(ls -l /home/master/applications/| awk '/^d/ {print $NF}')
                do
                        echo -e "\nApp: $i"
                        /var/cw/scripts/bash/duplicity_restore.sh --src $i -c
                done
else
                for args in "$@"
                do
                        cl_args=${args%/}
                        if app_exist "${applist[*]}" "$cl_args"; then
                                echo -e "\nApp: $cl_args"
                                /var/cw/scripts/bash/duplicity_restore.sh --src $cl_args -c
                        else
                                echo ""
                                echo -n $'\U274E '
                                echo "There seems to be no app by the name, $cl_args.."
                                echo "Available apps are: ${applist[*]}"
                        fi

                done
fi
        }

reset-services () {
    services=("nginx" "varnish" "apache2" "php-fpm" "mysql" "memcached" "redis-server")

    for service in "${services[@]}"; do
        if [[ $service == "php-fpm" ]]; then
            service=$(php -v | awk '{print "php"substr($2,1,3)"-fpm";exit}')
        fi

        echo "Restarting $service..."
        if systemctl restart $service; then
            echo "Successfully restarted: $(tput bold)$(tput setaf 1)$service$(tput sgr0)."
        else
            echo "Failed to restart: $(tput bold)$(tput setaf 1)$service$(tput sgr0)."
            echo "Latest logs:"
            journalctl -u $service -n 10 --no-pager | grep -v '^-- Logs begin'
        fi
    done
}

status-services () {
    echo "$(tput bold)$(tput setaf 1)Nginx:$(tput sgr0)"
    systemctl status nginx | awk '/Active/ {$1="";print $0}'

    echo "$(tput bold)$(tput setaf 1)Varnish:$(tput sgr0)"
    systemctl status varnish | awk '/Active/ {$1="";print $0}'

    echo "$(tput bold)$(tput setaf 1)Apache:$(tput sgr0)"
    systemctl status apache2 | awk '/Active/ {$1="";print $0}'

    echo "$(tput bold)$(tput setaf 1)PHP-FPM:$(tput sgr0)"
    systemctl status $(php -v | awk '{print "php"substr($2,1,3)"-fpm";exit}') | awk '/Active/ {$1="";print $0}'

    echo "$(tput bold)$(tput setaf 1)MySQL/MariaDB:$(tput sgr0)"
    systemctl status mysql | awk '/Active/ {$1="";print $0}'

    echo "$(tput bold)$(tput setaf 1)Memcache:$(tput sgr0)"
    systemctl status memcached | awk '/Active/ {$1="";print $0}'

    echo "$(tput bold)$(tput setaf 1)Redis:$(tput sgr0)"
    ( systemctl status redis-server | awk '/Active/ {$1="";print $0}' ) 2> /dev/null
}

usage () {
  num_cores=$(nproc)

  get_all_descendant_pids() {
    local parent_pid=$1
    local child_pids=$(pgrep -P $parent_pid)

    for child_pid in $child_pids; do
      get_all_descendant_pids $child_pid
    done

    echo $child_pids
  }

  services=("nginx" "varnish" "apache2" "php-fpm" "mysql" "memcached" "redis-server")

  for service in "${services[@]}"; do
    if [[ $service == "php-fpm" ]]; then
      service=$(php -v | awk '{print "php"substr($2,1,3)"-fpm";exit}')
    fi
    main_pid=$(systemctl show -p MainPID $service 2>/dev/null | cut -d= -f2)

    if [ -n "$main_pid" -a -e "/proc/$main_pid" ]; then
      all_pids="$main_pid $(get_all_descendant_pids $main_pid)"
      total_files=0
      total_cpu=0.0

      for pid in $all_pids; do
        if [ -n "$pid" -a -e "/proc/$pid" ]; then
          num_files=$(lsof -p $pid 2>/dev/null | wc -l)
          cpu=$(ps -p $pid -o %cpu= 2>/dev/null)

          if [ $? -eq 0 -a -n "$cpu" ]; then
            total_files=$((total_files + num_files))
            total_cpu=$(echo "$total_cpu + $cpu" | bc)
          fi
        fi
      done

      total_cpu=$(echo "$total_cpu / $num_cores" | bc -l)
      total_cpu=$(printf "%.1f" $total_cpu)

      echo "$(tput bold)$(tput setaf 1)$service: $(tput sgr0)"
      systemctl status $service | awk '/Tasks:|Memory/ {print $0}'
      echo "Open Files: $total_files"
      echo "CPU Usage: $total_cpu%"
    else
      echo "$(tput bold)$(tput setaf 1)$service: $(tput sgr0)Not running"
    fi
  done
}

sqlvars () {
        mysqladmin variables | tr -d " " | awk -F'|' '{print $2 " = " $3}'
        }
apptype () {
        awk '/server_name/ {split($2,a,"-") ; print a[1]; exit}' $HOMEDIR/$1/conf/server.nginx
        }

rm () {
array=( $@ )
FOUND="0"
for flags in "${!array[@]}"
do
        if [[ "${array[$flags]}" =~ ^-[rd]?f ]]; then
                FOUND="1"
                array[$flags]="${array[$flags]/f/I}"
                break
        fi
done
[[ "$FOUND" == "1" ]] && /bin/rm ${array[*]} || /bin/rm "$@"
        }

mv() {
    echo "About to run: mv $@"
    read -p "Continue? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        /bin/mv "$@"
    else
        echo "mv command cancelled"
        return 1
    fi
}

cleanup () {
        rm -f /root/.vimrc
        find /var/cw/systeam/.{vim,nano}-backup/ -type f -mtime +30 -delete
        }
trap cleanup EXIT